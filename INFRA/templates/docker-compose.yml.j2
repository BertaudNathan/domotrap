services:
  # 1) Init sqlite: crée le fichier DB avec notre script_db.sql
  db-init:
    image: alpine:3.20
    container_name: babyfoot-db-init
    volumes:
      - "{{ data_dir }}:/data"
      - "{{ sqlite_schema_dir }}:/init:ro"
    entrypoint: ["/bin/sh","-c"]
    command: >
      set -eux;
      apk add --no-cache sqlite;
      # Vérif présence du schéma
      if [ ! -f "/init/{{ sqlite_schema_file }}" ]; then
        echo "ERROR: /init/{{ sqlite_schema_file }} not found" >&2; exit 2;
      fi;
      # Init seulement si DB absente ou vide
      if [ ! -s "/data/babyfoot.db" ]; then
        echo "Init sqlite…";
        sqlite3 /data/babyfoot.db < "/init/{{ sqlite_schema_file }}";
        sqlite3 /data/babyfoot.db ".tables";
      else
        echo "DB already exists, skipping init";
      fi
    restart: "no"


  # 2) Backend Node (build local) — écoute 8080
  backend:
    build:
      context: {{ backend_build_context }}
    container_name: babyfoot-backend
    environment:
      NODE_ENV: production
      SQLITE_DB_PATH: "/data/babyfoot.db"
    volumes:
      - "{{ data_dir }}:/data"
    depends_on:
      db-init:
        condition: service_completed_successfully
    expose:
      - "8080"
    restart: unless-stopped

  # 3) Front (Nginx) — écoute 80 et reverse proxy /api → backend
  frontend:
    image: {{ frontend_image }}
    container_name: babyfoot-frontend
    ports:
      - "{{ http_port }}:80"
    volumes:
      - "{{ app_root }}/frontend:/usr/share/nginx/html:ro"
      - "{{ app_root }}/nginx.conf:/etc/nginx/nginx.conf:ro"
    depends_on:
      - backend
    restart: unless-stopped
